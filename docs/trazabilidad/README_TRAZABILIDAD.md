# üîç Sistema de Trazabilidad y Control de Calidad de Datos

## üéØ Objetivo

Este sistema proporciona herramientas para garantizar la **trazabilidad completa** de los datos en el pipeline ETL y **eliminar duplicados** que puedan afectar la integridad de los an√°lisis.

## üÜï Componentes Nuevos

### 1. **Generador de Datos Mejorado** 
üìÅ `01_GestionProyectos/scripts/generar_datos_mejorado.py`

**Mejoras sobre el generador original:**
- ‚úÖ Validaci√≥n de unicidad en tiempo de generaci√≥n
- ‚úÖ Hashing de registros para prevenir duplicados
- ‚úÖ Emails √∫nicos garantizados
- ‚úÖ Nombres de proyectos √∫nicos basados en tipo + cliente
- ‚úÖ Validaci√≥n autom√°tica post-generaci√≥n
- ‚úÖ Reporte de integridad de datos

**Diferencias con el generador original:**

| Caracter√≠stica | Original | Mejorado |
|---|---|---|
| Nombres de clientes | Pueden duplicarse | √önicos garantizados |
| Emails | Pueden duplicarse | √önicos garantizados |
| Proyectos | Pueden tener nombres similares | √önicos por tipo-cliente |
| Validaci√≥n | Manual | Autom√°tica |
| Asignaciones | Posibles duplicados | Sin duplicados |
| Reporte | B√°sico | Completo con estad√≠sticas |

### 2. **Verificador de Trazabilidad**
üìÅ `verificar_trazabilidad.py`

**Funcionalidades:**
- üîç B√∫squeda de registros entre BD origen y destino
- üìä Comparaci√≥n de conteos
- üö® Detecci√≥n de duplicados
- üìã Identificaci√≥n de datos no migrados
- üìà Reportes de auditor√≠a

## üöÄ Inicio R√°pido

### Instalaci√≥n de Dependencias
```bash
# Activar entorno virtual
source .venv/bin/activate

# Instalar dependencias (si no est√° instalado)
pip install -r requirements.txt
```

### Generar Datos Limpios
```bash
# Usar el generador mejorado
python 01_GestionProyectos/scripts/generar_datos_mejorado.py
```

**Output esperado:**
```
üöÄ Generador de Datos MEJORADO - Sistema de Gesti√≥n de Proyectos
   ‚úì Con trazabilidad
   ‚úì Sin duplicados
   ‚úì Validaci√≥n de integridad
======================================================================
‚úÖ Conectado a BD: gestionproyectos_hist
...
üîç Validando integridad de datos...
  ‚úÖ Clientes √∫nicos: 8/8
  ‚úÖ Emails √∫nicos: 8/8
  ‚úÖ Empleados √∫nicos: 15/15
  ...
üéâ ¬°Datos de prueba generados exitosamente!
```

### Ejecutar ETL
```bash
python 02_ETL/scripts/etl_principal.py
```

### Verificar Trazabilidad
```bash
# Opci√≥n 1: Modo interactivo
python verificar_trazabilidad.py

# Opci√≥n 2: Reporte completo
python verificar_trazabilidad.py reporte
```

## üìä Verificaciones Implementadas

### 1. Control de Duplicados en Origen

El generador mejorado previene duplicados en:

#### Clientes:
- **Nombre de empresa**: √önico por cliente
- **Email**: √önico en toda la tabla
- **Validaci√≥n**: Usa set() para tracking en memoria

```python
# Ejemplo de implementaci√≥n
clientes_generados = set()

def generar_nombre_unico_cliente():
    nombre = fake.company()
    while nombre in clientes_generados:
        nombre = f"{fake.company()} {random.randint(100, 999)}"
    clientes_generados.add(nombre)
    return nombre
```

#### Empleados:
- **Nombre completo**: √önico por empleado
- **Validaci√≥n**: Similar a clientes

#### Proyectos:
- **Nombre**: Combinaci√≥n √∫nica de tipo + cliente
- **Hash tracking**: Para prevenir duplicados complejos

```python
# Formato: "Tipo - Cliente"
nombre = f"{tipo} - {empresa}"
while nombre in proyectos_generados:
    nombre = f"{tipo} - {empresa} v{contador}"
    contador += 1
```

#### Asignaciones:
- **Equipo-Empleado**: Un empleado no se asigna dos veces al mismo equipo
- **Tarea-Equipo**: Una tarea no se asigna dos veces al mismo equipo
- **Hash-based tracking**: Para validaci√≥n eficiente

### 2. Trazabilidad entre Bases de Datos

El verificador permite rastrear cualquier registro desde origen hasta destino:

#### Ejemplo: Buscar un proyecto
```bash
python verificar_trazabilidad.py
# Opci√≥n 2: Buscar proyecto por ID
# Ingresar: 5
```

**Resultado:**
```
üîç Buscando Proyecto ID: 5
======================================================================

üì¶ BD ORIGEN (gestionproyectos_hist):
----------------------------------------------------------------------
  id_proyecto                  : 5
  nombre                       : Sistema Web - Tech Corp
  fecha_inicio                 : 2024-01-15
  presupuesto                  : 200000.00
  id_estado                    : 3
  nombre_estado                : Completado

üì¶ BD DESTINO (dw_proyectos_hist):
----------------------------------------------------------------------
  id_proyecto                  : 5
  nombre_proyecto              : Sistema Web - Tech Corp
  duracion_planificada         : 120
  duracion_real                : 118
  cumplimiento_tiempo          : 1
  cumplimiento_presupuesto     : 1
  porcentaje_completado        : 100.00

‚úÖ Proyecto encontrado en ambas bases de datos
```

## üîß Uso del Verificador de Trazabilidad

### Modo Interactivo
```bash
python verificar_trazabilidad.py
```

**Men√∫:**
```
üîç VERIFICADOR DE TRAZABILIDAD - Sistema ETL
======================================================================
1. Verificar conteos generales
2. Buscar proyecto por ID
3. Buscar cliente por nombre
4. Buscar empleado por nombre
5. Verificar duplicados en BD Origen
6. Listar proyectos no migrados
7. Generar reporte completo
0. Salir
```

### Modo L√≠nea de Comandos
```bash
# Reporte completo de trazabilidad
python verificar_trazabilidad.py reporte

# Solo verificar conteos
python verificar_trazabilidad.py conteos

# Buscar duplicados
python verificar_trazabilidad.py duplicados

# Proyectos no migrados
python verificar_trazabilidad.py no-migrados
```

## üìà Casos de Uso

### Caso 1: Validar Generaci√≥n de Datos
**Problema**: Quiero asegurarme de que no hay duplicados despu√©s de generar datos.

**Soluci√≥n**:
```bash
# 1. Generar datos
python 01_GestionProyectos/scripts/generar_datos_mejorado.py

# 2. Verificar duplicados
python verificar_trazabilidad.py duplicados
```

**Resultado esperado**: ‚úÖ Todos los checks en verde

### Caso 2: Verificar ETL Exitoso
**Problema**: El ETL termin√≥ pero quiero confirmar que todos los datos se migraron.

**Soluci√≥n**:
```bash
python verificar_trazabilidad.py conteos
```

**Resultado esperado**:
```
üìä VERIFICACI√ìN DE CONTEOS
======================================================================
| Entidad                       | BD Origen | BD Destino | Estado |
|-------------------------------|-----------|------------|--------|
| Clientes                      | 8         | 8          | ‚úÖ     |
| Empleados                     | 15        | 15         | ‚úÖ     |
| Proyectos                     | 8         | 8          | ‚úÖ     |
| HechoProyecto                 | 8         | 8          | ‚úÖ     |
```

### Caso 3: Buscar un Cliente Espec√≠fico
**Problema**: Un usuario reporta que los datos de "Tech Corp" no aparecen en el dashboard.

**Soluci√≥n**:
```bash
python verificar_trazabilidad.py
# Opci√≥n 3: Buscar cliente por nombre
# Ingresar: Tech Corp
```

**Posibles resultados**:
- ‚úÖ Cliente encontrado en ambas BD ‚Üí El problema es del dashboard
- ‚ùå Cliente no en DW ‚Üí Ejecutar ETL nuevamente
- ‚ùå Cliente no en origen ‚Üí Regenerar datos

### Caso 4: Auditor√≠a Completa
**Problema**: Necesito un reporte completo del estado del sistema.

**Soluci√≥n**:
```bash
python verificar_trazabilidad.py reporte > auditoria_$(date +%Y%m%d).txt
```

Esto genera un archivo con:
- Conteos de todas las entidades
- Lista de duplicados (si existen)
- Proyectos no migrados
- Timestamp del reporte

## üõ†Ô∏è Soluci√≥n de Problemas

### Problema 1: Duplicados Detectados

**S√≠ntoma**:
```
‚ùå Clientes duplicados encontrados:
  ‚Ä¢ Acme Corp: 2 veces
```

**Causa**: Se us√≥ el generador original en lugar del mejorado.

**Soluci√≥n**:
```bash
# 1. Limpiar BD origen
mysql -u root -p gestionproyectos_hist < 01_GestionProyectos/scripts/crear_bd_origen.sql

# 2. Usar generador mejorado
python 01_GestionProyectos/scripts/generar_datos_mejorado.py

# 3. Verificar
python verificar_trazabilidad.py duplicados
```

### Problema 2: Conteos No Coinciden

**S√≠ntoma**:
```
| Clientes | 10 | 8 | ‚ùå |
```

**Posibles causas**:
1. Clientes inactivos en origen (solo se migran activos)
2. Error en el ETL
3. ETL no se ejecut√≥ despu√©s de regenerar datos

**Diagn√≥stico**:
```bash
# Verificar clientes activos en origen
mysql -u root -p -e "USE gestionproyectos_hist; 
SELECT COUNT(*) as total, 
       SUM(activo) as activos,
       COUNT(*) - SUM(activo) as inactivos 
FROM Cliente;"
```

**Soluci√≥n**: Re-ejecutar ETL
```bash
python 02_ETL/scripts/etl_principal.py
python verificar_trazabilidad.py conteos
```

### Problema 3: Proyecto No Migrado

**S√≠ntoma**:
```
‚ö†Ô∏è  4 proyecto(s) NO migrado(s):
| ID | Nombre               | Estado      | Progreso |
|----|---------------------|-------------|----------|
| 3  | Portal Web ABC      | En Progreso | 65%      |
```

**Causa**: Solo se migran proyectos **Completados** o **Cancelados** (estados 3 y 4).

**Soluci√≥n**: 
Esto es comportamiento esperado. Si necesitas migrar todos los proyectos:

1. Modificar filtro en ETL:
```python
# En etl_principal.py, l√≠nea ~200
# Cambiar:
WHERE p.id_estado IN (3, 4)
# Por:
WHERE 1=1  # Migrar todos
```

2. Re-ejecutar ETL

### Problema 4: No Se Puede Conectar a BD

**S√≠ntoma**:
```
‚ùå Error conectando: Access denied for user 'root'@'localhost'
```

**Soluci√≥n**:
```bash
# Verificar que MySQL est√© corriendo
sudo systemctl status mysql  # Linux
brew services list | grep mysql  # macOS

# Verificar credenciales en el script
# Editar verificar_trazabilidad.py l√≠neas 19-25
```

## üìö Estructura de Datos

### Garant√≠as de Unicidad

| Tabla | Campo √önico | M√©todo | Nivel |
|-------|------------|---------|-------|
| Cliente | nombre | Set tracking | Aplicaci√≥n |
| Cliente | email | Set tracking | Aplicaci√≥n |
| Empleado | nombre | Set tracking | Aplicaci√≥n |
| Equipo | nombre_equipo | Set tracking | Aplicaci√≥n |
| Proyecto | nombre | Hash-based | Aplicaci√≥n |
| MiembroEquipo | (id_equipo, id_empleado) | Hash-based | Aplicaci√≥n |
| TareaEquipoHist | (id_tarea, id_equipo, fecha) | Hash-based | Aplicaci√≥n |

**Nota**: Las validaciones se hacen a nivel de aplicaci√≥n (Python) durante la generaci√≥n. Para garant√≠as a nivel de BD, se pueden agregar constraints UNIQUE en los scripts SQL.

## üîê Mejores Pr√°cticas

### 1. Siempre Usar el Generador Mejorado
‚ùå **No hacer**:
```bash
python 01_GestionProyectos/scripts/generar_datos.py
```

‚úÖ **Hacer**:
```bash
python 01_GestionProyectos/scripts/generar_datos_mejorado.py
```

### 2. Verificar Despu√©s de Cada ETL
```bash
# Despu√©s de ejecutar ETL
python 02_ETL/scripts/etl_principal.py

# Siempre verificar
python verificar_trazabilidad.py conteos
```

### 3. Reporte Peri√≥dico
```bash
# Agregar a cron para ejecuci√≥n diaria
0 9 * * * cd /ruta/proyecto && python verificar_trazabilidad.py reporte >> logs/trazabilidad_$(date +\%Y\%m\%d).log
```

### 4. Backup Antes de Regenerar
```bash
# Backup de BD origen
mysqldump -u root -p gestionproyectos_hist > backup_origen_$(date +%Y%m%d).sql

# Backup de DW
mysqldump -u root -p dw_proyectos_hist > backup_dw_$(date +%Y%m%d).sql

# Luego regenerar
python 01_GestionProyectos/scripts/generar_datos_mejorado.py
```

## üìñ Documentaci√≥n Adicional

- üìÑ **Gu√≠a Completa**: `GUIA_TRAZABILIDAD.md`
- üìÑ **README Principal**: `README.md`
- üìÑ **Documentaci√≥n ETL**: `02_ETL/README.md`
- üìÑ **Ejemplos de Uso**: `EJEMPLOS_USO.md`

## üéì Preguntas Frecuentes

**P: ¬øPuedo usar ambos generadores?**
R: No recomendado. El generador mejorado reemplaza al original. Usar solo uno para consistencia.

**P: ¬øQu√© pasa con las fechas? ¬øPueden duplicarse?**
R: S√≠, las fechas **pueden y deben** duplicarse. La validaci√≥n de unicidad excluye fechas intencionalmente.

**P: ¬øSe validan duplicados en el DataWarehouse?**
R: El verificador detecta duplicados en **origen**. El DW deber√≠a heredar la limpieza del origen. Si hay duplicados en DW, indica un problema en el ETL.

**P: ¬øC√≥mo agrego validaciones personalizadas?**
R: Modifica `validar_integridad_datos()` en `generar_datos_mejorado.py`:
```python
def validar_integridad_datos(cursor):
    # Agregar tu validaci√≥n
    cursor.execute("SELECT ... tu query ...")
    # Procesar resultados
```

**P: ¬øFunciona con BD distribuida (3 m√°quinas)?**
R: S√≠, pero debes modificar las credenciales de conexi√≥n en cada script seg√∫n tu configuraci√≥n.

## ü§ù Contribuciones

Para mejorar el sistema de trazabilidad:
1. Documenta el problema o mejora
2. Crea tests si es posible
3. Actualiza esta documentaci√≥n

---

**√öltima actualizaci√≥n**: Octubre 2025  
**Versi√≥n**: 2.0  
**Autor**: Sistema ETL - Gesti√≥n de Proyectos
